#!/bin/sh

BUNDLE=$1
VERSION=$2

[ "${BUNDLE}" = "" ] && echo && echo "You must specify a bundle!" && echo && exit

WORKDIR=bundle.tmp

rm -rf $WORKDIR > /dev/null 2>&1

mkdir $WORKDIR

cp $BUNDLE $WORKDIR

(
  cd $WORKDIR

  jar xf $BUNDLE

  POM=project.xml

  ../d2u ${POM}

  [ ! -f ${POM} ] && echo && echo "Cannot deploy without the project.xml file!" && echo && exit

  if [ ! -z $VERSION ]
  then
    version=$VERSION
  else
    version=`cat ${POM} | tr '\n' ' ' | sed 's#<versions>.*</versions>##' | sed 's#<dependencies>.*</dependencies>##' | grep '<version>' | sed -e 's#^.*<version>##;s#</version>.*$##'`

    if [ -z $version ]
    then
      version=`grep currentVersion ${POM} | sed -e 's/^ *//;s/<currentVersion>//;s/<\/currentVersion>//'`
    fi
  fi

  artifactId=`cat ${POM} | tr '\n' ' ' | sed 's#<dependencies>.*</dependencies>##' | grep '<artifactId>' | sed -e 's#^.*<artifactId>##;s#</artifactId>.*$##'`

  if [ -z $artifactId ]
  then
    artifactId=`cat ${POM} | tr '\n' ' ' | sed 's#<versions>.*</versions>##' | sed 's#<developers>.*</developers>##' | sed 's#<dependencies>.*</dependencies>##' | grep '<id>' | sed -e 's#^.*<id>##;s#</id>.*$##'`
  fi
  
  groupId=`cat ${POM} | tr '\n' ' ' | sed 's#<dependencies>.*</dependencies>##' | grep '<groupId>' | sed -e 's#^.*<groupId>##;s#</groupId>.*$##'`  

  if [ -z $groupId ]
  then
    groupId=${artifactId}
  fi

  version=`echo ${version} | sed -e 's/ *$//'`
  artifactId=`echo ${artifactId} | sed -e 's/ *$//'`
  groupId=`echo ${groupId} | sed -e 's/ *$//'`  

  echo
  echo "   version: [${version}]"
  echo "   groupId: [${groupId}]"  
  echo "artifactId: [${artifactId}]"
  echo

  LIC=LICENSE.txt

  # A little help for manually created upload bundles
  [ -f license.txt ] && mv license.txt $LIC
  [ -f licence.txt ] && mv licence.txt $LIC

  [ ! -f $LIC ] && echo && echo "Cannot deploy without the $LIC file!" && echo && exit

  cp project.xml ${artifactId}-${version}.pom

  ../d2u $LIC

  ../deploy-lic $LIC ${groupId}
  
  ../deploy-pom ${artifactId}-${version}.pom ${groupId}
  
  artifactType=`echo ${artifactId} | sed -e 's/maven-.*-plugin//'`
  
  if [ -z ${artifactType} ]
  then
    echo "Deploying Plugin ..."
    ../deploy-plugin ${artifactId}-${version}.jar ${groupId}        
  else
    echo "Deploying JAR ..."
    ../deploy-jar ${artifactId}-${version}.jar ${groupId}        
  fi    
)  
